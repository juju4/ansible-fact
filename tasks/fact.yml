---

# https://github.com/fkie-cad/FACT_core/blob/master/INSTALL.md
- name: Debian | refresh apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  when: ansible_os_family == "Debian"

- import_tasks: redhat-mongodb.yml
  when: ansible_os_family == "RedHat"

- name: Update latest packages
  package:  # noqa package-latest
    name: '*'
    state: latest

- name: Ensure dependencies packages are present
  package:
    name: "{{ fact_pkgs }}"
    state: present

- name: Ensure dedicated user exists
  user:
    name: _fact
    home: "{{ fact_home }}"
    comment: 'Firmware Analysis and Comparison Tool (FACT)'
    system: yes
    groups: docker
    append: yes
    state: present

- name: give sudoers access to fact user - at least for install
  lineinfile:
    dest: /etc/sudoers.d/fact-user
    line: "{{ fact_user }} ALL=(ALL) NOPASSWD:ALL"
    mode: '0440'
    create: yes
    backup: "{{ fact_backup | default(false) }}"

- name: Ensure /etc/sudoers.d/fact_overrides exists
  template:
    src: fact_overrides.j2
    dest: /etc/sudoers.d/fact_overrides
    mode: '0440'
    backup: "{{ fact_backup | default(false) }}"

- name: clone FACT repository
  git:
    repo: https://github.com/fkie-cad/FACT_core.git
    dest: "{{ fact_root }}"
    version: "{{ fact_version | default('v3.1.3') }}"
    update: no
    force: no
  become: yes
  become_user: "{{ fact_user }}"

- name: Ensure directories exist
  file:
    path: "{{ item.p }}"
    state: directory
    owner: "{{ fact_user }}"
    mode: "{{ item.m }}"
  with_items:
    - { p: "{{ fact_datadir }}", m: '0700' }
    - { p: "{{ fact_logdir }}", m: '0700' }
    - { p: "{{ fact_root }}/src/bin", m: '0700' }

- name: copy pip requirements file
  copy:
    src: requirements.txt
    dest: "{{ fact_home }}/requirements.txt"
    mode: '0600'

# better in virtualenv?
- name: FACT pre-install | pip dependencies
  pip:
    requirements: "{{ fact_home }}/requirements.txt"
    executable: pip3
    extra_args: --upgrade

- name: Pull Docker images
  docker_image:
    name: "{{ item }}"
    source: pull
  with_items: "{{ fact_docker_images }}"

- name: Ensure dependencies services are started
  service:
    name: clamav-daemon
    state: started
  when: ansible_os_family == "Debian"

# review src/config/main.cfg, src/config/mongod.conf
- name: Update config
  ini_file:
    path: "{{ fact_root }}/src/config/main.cfg"
    section: "{{ item.s }}"
    option: "{{ item.o }}"
    value: "{{ item.v }}"
    mode: '0600'
    backup: "{{ fact_backup | default(false) }}"
  with_items: "{{ fact_main_config }}"
  notify:
    - restart fact-db
    - restart fact-backend
    - restart fact-frontend

- name: Github | review nginx.conf
  replace:
    dest: "{{ fact_root }}/src/config/nginx.conf"
    regexp: "{{ item.re }}"
    replace: "{{ item.rep }}"
    mode: '0644'
  with_items:
    - { re: '^        listen   443;', rep: '        listen   443 ssl;' }
    - { re: '^        ssl on;', rep: '        # ssl on;' }
  when: fact_nginx_shim

- name: Nginx | Ensure logs in target directory
  replace:
    dest: "{{ fact_root }}/src/config/nginx.conf"
    regexp: "access_log .* compression;"
    replace: "access_log {{ fact_logdir }}/fact_web.log compression;"
    mode: '0644'

- import_tasks: plugins-binwalk.yml
- import_tasks: plugins-linter.yml
- import_tasks: plugins-crypto_hints.yml
- import_tasks: plugins-oms.yml
- import_tasks: plugins-software_components.yml
- import_tasks: plugins-cve_lookup.yml
- import_tasks: plugins-qemu_exec.yml
- import_tasks: plugins-users_and_passwords.yml
- import_tasks: plugins-ip_and_uri_finder.yml
- import_tasks: plugins-input_vectors.yml

- import_tasks: mongodb.yml
- import_tasks: variety.yml

- import_tasks: statistics.yml
- import_tasks: rsyslog.yml
- import_tasks: systemd.yml
